<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Company Income Statement Sankey Diagram</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center justify-center p-4">
    <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-6xl">
        <h1 class="text-3xl font-bold mb-6 text-center text-gray-800">Company Income Statement Sankey Diagram</h1>
        <div class="mb-4 flex items-center">
            <input type="text" id="companyName" placeholder="Enter Company Name" class="mr-2 p-2 border rounded flex-grow">
            <input type="file" id="csvFile" accept=".csv" class="mr-2 p-2 border rounded">
            <button id="renderButton" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                Render Diagram
            </button>
        </div>
        <div id="sankey" class="w-full h-[800px]"></div>
    </div>

    <script>
        let csvData;
        let companyName = "Company";

        document.getElementById('companyName').addEventListener('input', function(e) {
            companyName = e.target.value || "Company";
            if (csvData) {
                renderSankeyDiagram(csvData);
            }
        });

        document.getElementById('csvFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            Papa.parse(file, {
                header: true,
                dynamicTyping: true,
                complete: function(results) {
                    csvData = results.data;
                    console.log('CSV Data:', csvData);
                }
            });
        });

        document.getElementById('renderButton').addEventListener('click', function() {
            if (!csvData) {
                alert('Please upload a CSV file first.');
                return;
            }
            renderSankeyDiagram(csvData);
        });

        function renderSankeyDiagram(data) {
            const nodeColors = {
                "Revenue": "#3498db",
                "Cost of revenue": "#e74c3c",
                "Gross profit": "#2ecc71",
                "Operating expenses": "#e67e22",
                "Operating profit": "#27ae60",
                "Net profit": "#2980b9"
            };

            const sankeyData = {
                type: "sankey",
                orientation: "h",
                node: {
                    padding: [5, 10],
                    thickness: 15,
                    line: { color: "black", width: 0.5 },
                    textfont: {weight: 700},  // Add this line for bold node labels
                    label: [],
                    color: []
                },
                link: {
                    source: [],
                    target: [],
                    value: [],
                    color: [],
                    arrangement: 'snap'
                }
            };

            const nodeIndices = {};
            const nodeValues = {};
            let nodeIndex = 0;

            function getNodeIndex(name, category) {
                if (!(name in nodeIndices)) {
                    nodeIndices[name] = nodeIndex++;
                    sankeyData.node.label.push(name);
                    sankeyData.node.color.push(getNodeColor(category));
                    nodeValues[name] = { incoming: 0, outgoing: 0 };
                }
                return nodeIndices[name];
            }

            function addLink(source, target, value, category) {
                const sourceIndex = getNodeIndex(source, category);
                const targetIndex = getNodeIndex(target, category);
                sankeyData.link.source.push(sourceIndex);
                sankeyData.link.target.push(targetIndex);
                sankeyData.link.value.push(value);
                sankeyData.link.color.push(getLinkColor(category));

                nodeValues[source].outgoing += value;
                nodeValues[target].incoming += value;
            }

            function getNodeColor(category) {
                switch(category) {
                    case "revenue":
                        return "#696969";  // Grey for revenue streams
                    case "profit":
                        return "#00a34c";  // Green for profit-related streams
                    case "expense":
                        return "#d1003f";  // Red for expense/cost-related streams
                    default:
                        return "#000000";  // Black as a fallback
                }
            }

            function getLinkColor(category) {
                switch(category) {
                    case "revenue":
                        return "#bbbbbb";  // Grey for revenue streams
                    case "profit":
                        return "#8cd5ae";  // Green for profit-related streams
                    case "expense":
                        return "#ea8ca8";  // Red for expense/cost-related streams
                    default:
                        return "#000000";  // Black as a fallback
                }
            }

            // Process data
            data.forEach(row => {
                if (row.source && row.target && row.value) {
                    addLink(row.source, row.target, row.value, row.category);
                }
            });

            // Update node labels with values
            sankeyData.node.label = sankeyData.node.label.map(label => {
                const value = Math.max(nodeValues[label].incoming, nodeValues[label].outgoing);
                return `${label} ($${value.toFixed(1)}B)`;
            });

            const layout = {
                title: `${companyName} Earnings Report`,
                font: { size: 15, color: "#000000" },
                autosize: true,
                margin: { l: 10, r: 10, b: 10, t: 10, pad: 4 },
                paper_bgcolor: "#ffffff",
                plot_bgcolor: "#ffffff",
                sankey: {
                    node: {
                      label: sankeyData.node.label,
                      color: sankeyData.node.color,
                      pad: 10,
                      thickness: 10,
                      line: {
                        color: "black",
                        width: 0.5
                      }
                   },
                   link: {
                      color: sankeyData.link.color
                   }
                }
            };

            Plotly.newPlot('sankey', [sankeyData], layout, {responsive: true});
        }
    </script>
</body>
</html>
